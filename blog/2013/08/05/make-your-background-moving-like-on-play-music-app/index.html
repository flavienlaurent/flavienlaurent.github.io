
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Make Your Background Moving Like on the Play Music App - Flavien Laurent</title>
  <meta name="author" content="Flavien Laurent">

  
  <meta name="description" content="After the Google I/O keynote 2013, like many of you, I&rsquo;ve received an update of the Play Music app. I think that it&rsquo;s one of the most &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://flavienlaurent.com/blog/2013/08/05/make-your-background-moving-like-on-play-music-app">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Flavien Laurent" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43113155-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Flavien Laurent</a></h1>
  
    <h2>The Android Framework, step by step</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:flavienlaurent.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
	
	<li><a href="http://github.com/flavienlaurent" title="Github Profile" target="_blank"></i>Github</a></li>
	
	
	
	<li><a href="http://twitter.com/flavienlaurent" title="Twitter Profile" target="_blank">Twitter</a></li>
	
	
	<li><a href="http://plus.google.com/103561222519914490723" title="Google+ Profile" target="_blank">G+</a></li>
	
	
	
	<li><a href="/atom.xml" title="RSS" target="_blank">RSS</a></li>
	
	
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Make Your Background Moving Like on the Play Music App</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-08-05T18:56:00+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>6:56 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>After the Google I/O keynote 2013, like many of you, I&rsquo;ve received an update of the Play Music app. I think that it&rsquo;s one of the most beautiful and well-made application of Google. This app contains lots of animations, effects and good ux patterns to reproduce. In this first article, I want to talk specifically about the animated background in the now playing screen.</p>

<!--more-->


<p>If you start to play a song, you&rsquo;re going to see the album cover moving slowly (from right to left <em>to right</em> in portrait and from bottom to top <em>to bottom</em> in landscape). This animation is visually simple but it&rsquo;s kind of tricky.</p>

<p>If you still have not understand the animation I want to explain to you, you can take a look on the animated gif below or simply download &amp; install the sample application.</p>

<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/setimagematrix-demo.gif"></p>

<p><a href="https://github.com/flavienlaurent/PanningView/blob/master/PanningView-debug-unaligned.apk?raw=true">Download Sample Application</a></p>

<h1>Playing with setImageMatrix</h1>

<h2>Deep in the framework</h2>

<p>Here is the offical documentation for <code>ImageView.setImageMatrix</code></p>

<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/setimagematrix-documentation.png"></p>

<p>As you can see, this is a short explaination.
Basically, it replaces the matrix of the ImageView (set identity matrix if <code>null</code> is passed). Then, two methods are called: <code>configureBounds</code> and <code>invalidate</code>.</p>

<ul>
<li>configureBounds: according to the <a href="http://developer.android.com/reference/android/widget/ImageView.ScaleType.html"><code>scaleType</code></a>, the drawable is bounded and/or the draw matrix is modified. For example, in <code>CENTER_CROP</code> mode, the draw matrix is scaled and translated. In <code>MATRIX</code> mode, the draw matrix is only assigned to the matrix of the ImageView.</li>
<li>invalidate (i.e. <code>onDraw</code>): the only interesting thing is that the draw matrix (if not null) is concatenated with the canvas</li>
</ul>


<h2>Let&rsquo;s play</h2>

<p>If you want the ImageView to be drawn fully respecting your matrix, don&rsquo;t forget to set the <code>MATRIX</code> scaleType.</p>

<figure class='code'><figcaption><span>in code</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mImageView</span><span class="o">.</span><span class="na">setScaleType</span><span class="o">(</span><span class="n">ScaleType</span><span class="o">.</span><span class="na">MATRIX</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>in xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>android:scaleType=&quot;matrix&quot;
</span></code></pre></td></tr></table></div></figure>


<p>Here is the ImageView with the original matrix:</p>

<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/setimagematrix-original.png"></p>

<h3>Scale (factor 2 on x and y)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">Matrix</span> <span class="n">matrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Matrix</span><span class="o">();</span>
</span><span class='line'><span class="n">matrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
</span><span class='line'><span class="n">imageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">matrix</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/setimagematrix-scale.png"></p>

<h3>Scale and rotate (15Â°)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">Matrix</span> <span class="n">matrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Matrix</span><span class="o">();</span>
</span><span class='line'><span class="n">matrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
</span><span class='line'><span class="n">matrix</span><span class="o">.</span><span class="na">postRotate</span><span class="o">(</span><span class="mi">15</span><span class="o">);</span>
</span><span class='line'><span class="n">imageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">matrix</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/setimagematrix-scale-rotate.png"></p>

<h3>Scale and translate (the most interesting for us)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">Matrix</span> <span class="n">matrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Matrix</span><span class="o">();</span>
</span><span class='line'><span class="n">matrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
</span><span class='line'><span class="n">matrix</span><span class="o">.</span><span class="na">postTranslate</span><span class="o">(</span><span class="mi">45</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'><span class="n">imageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">matrix</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/setimagematrix-scale-translate.png"></p>

<h1>Make your background moving</h1>

<p>There are three phases to achieve in order to make your background moving:</p>

<ol>
<li>scale to fit the container</li>
<li>animate the background by doing some translations</li>
<li>loop this animation</li>
</ol>


<p>Last thing that you must know, we&rsquo;re gonna work with this background image:</p>

<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/mybm-original.png"></p>

<h2>Step1: scale to fit</h2>

<p>This step is the easiest one. All you have to do is just to calculate the scale factor between the container size (i.e. the ImageView) and the drawable intrinsic size according to the current orientation and keeping the ratio:</p>

<ul>
<li>portrait, the drawable must be scaled to use all the available height</li>
<li>landscape, the drawable must be scale to use all the available width.</li>
</ul>


<p><em>Suppose we are in portrait mode, the ImageView <strong>has</strong> a drawable and ImageView is fully laid out.</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">float</span> <span class="n">scaleFactor</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">imageView</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">drawable</span><span class="o">.</span><span class="na">getIntrinsicHeight</span><span class="o">();</span>
</span><span class='line'><span class="n">mMatrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="n">scaleFactor</span><span class="o">,</span> <span class="n">scaleFactor</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; which gives us the following result: as you can see, the drawable top and bottom fit the top and bottom container.</p>

<p><img src="/media/2013-08-05-make-your-background-moving-like-on-play-music-app/mybm-scale2fit.png"></p>

<h2>Step2: animate your background</h2>

<p>For this step, we&rsquo;re gonna use a powerfull concept of the Android animation framework: <a href="http://developer.android.com/reference/android/animation/ValueAnimator.html"><code>ValueAnimator</code></a>.</p>

<p><strong>Don&rsquo;t forget to read all the provided documentation about this class.</strong></p>

<p>The principle is to make your background moving on the x axis by applying some translations on the ImageView matrix.</p>

<p>Remember that all the matrix operations are <em>post</em>|<em>pre</em>concatenated. You can read a good explaination in <a href="http://stackoverflow.com/questions/3855578/android-matrix-what-is-the-different-between-preconcat-and-postconcat">here</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mAnimator</span> <span class="o">=</span> <span class="n">ValueAnimator</span><span class="o">.</span><span class="na">ofFloat</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
</span><span class='line'><span class="n">mAnimator</span><span class="o">.</span><span class="na">addUpdateListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ValueAnimator</span><span class="o">.</span><span class="na">AnimatorUpdateListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationUpdate</span><span class="o">(</span><span class="n">ValueAnimator</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">float</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">Float</span><span class="o">)</span> <span class="n">animation</span><span class="o">.</span><span class="na">getAnimatedValue</span><span class="o">();</span>
</span><span class='line'>      <span class="n">matrix</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
</span><span class='line'>      <span class="n">matrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="n">scaleFactor</span><span class="o">,</span> <span class="n">scaleFactor</span><span class="o">);</span>
</span><span class='line'>      <span class="n">matrix</span><span class="o">.</span><span class="na">postTranslate</span><span class="o">(-</span><span class="n">value</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>      <span class="n">imageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">matrix</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span><span class='line'><span class="n">mAnimator</span><span class="o">.</span><span class="na">setDuration</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
</span><span class='line'><span class="n">mAnimator</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is probably (<em>for sure</em>) a better way to those operations on the matrix. <a href="http://twitter.com/flavienlaurent">Please tell me how?</a></p>

<h2>Step3: where to stop and how to loop</h2>

<p>The last step consists in:</p>

<ol>
<li>stopping the animation to constantly match the real drawable bounds</li>
</ol>


<p>To do that, you&rsquo;ll need a <a href="http://developer.android.com/reference/android/graphics/RectF.html"><code>RectF</code></a> to maintain the real size and position of the background. Whenever you change the matrix, you must update the rect using the <a href="http://developer.android.com/reference/android/graphics/Matrix.html#mapRect(android.graphics.RectF"><code>mapRect(RectF rect)</code></a>) function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mDisplayRect</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">drawable</span><span class="o">.</span><span class="na">getIntrinsicWidth</span><span class="o">(),</span> <span class="n">drawable</span><span class="o">.</span><span class="na">getIntrinsicHeight</span><span class="o">());</span>
</span><span class='line'><span class="n">mMatrix</span><span class="o">.</span><span class="na">mapRect</span><span class="o">(</span><span class="n">mDisplayRect</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>reverse the animation when the translation is complete (i.e. a drawable bound is reached)</li>
</ol>


<p>This part is a piece of cake. You have to keep a variable for the current direction and to configure the ValueAnimator from/to values in order to make the right animation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">if</span><span class="o">(</span><span class="n">mDirection</span> <span class="o">==</span> <span class="n">RightToLeft</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">animate</span><span class="o">(</span><span class="n">mDisplayRect</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">mDisplayRect</span><span class="o">.</span><span class="na">left</span> <span class="o">-</span> <span class="o">(</span><span class="n">mDisplayRect</span><span class="o">.</span><span class="na">right</span> <span class="o">-</span> <span class="n">mImageView</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()));</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">animate</span><span class="o">(</span><span class="n">mDisplayRect</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>All together</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RightToLeft</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LeftToRight</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DURATION</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="n">ValueAnimator</span> <span class="n">mCurrentAnimator</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Matrix</span> <span class="n">mMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Matrix</span><span class="o">();</span>
</span><span class='line'><span class="kd">private</span> <span class="n">ImageView</span> <span class="n">mImageView</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">float</span> <span class="n">mScaleFactor</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">int</span> <span class="n">mDirection</span> <span class="o">=</span> <span class="n">RightToLeft</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">RectF</span> <span class="n">mDisplayRect</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">RectF</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mImageView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">imageView</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mImageView</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="nf">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">mScaleFactor</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span>  <span class="n">mImageView</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">mImageView</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">().</span><span class="na">getIntrinsicHeight</span><span class="o">();</span>
</span><span class='line'>          <span class="n">mMatrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="n">mScaleFactor</span><span class="o">,</span> <span class="n">mScaleFactor</span><span class="o">);</span>
</span><span class='line'>          <span class="n">mImageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">mMatrix</span><span class="o">);</span>
</span><span class='line'>          <span class="n">animate</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">});</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">animate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">updateDisplayRect</span><span class="o">();</span>
</span><span class='line'>  <span class="k">if</span><span class="o">(</span><span class="n">mDirection</span> <span class="o">==</span> <span class="n">RightToLeft</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">animate</span><span class="o">(</span><span class="n">mDisplayRect</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">mDisplayRect</span><span class="o">.</span><span class="na">left</span> <span class="o">-</span> <span class="o">(</span><span class="n">mDisplayRect</span><span class="o">.</span><span class="na">right</span> <span class="o">-</span> <span class="n">mImageView</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()));</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">animate</span><span class="o">(</span><span class="n">mDisplayRect</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="mf">0.0f</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">animate</span><span class="o">(</span><span class="kt">float</span> <span class="n">from</span><span class="o">,</span> <span class="kt">float</span> <span class="n">to</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span> <span class="o">=</span> <span class="n">ValueAnimator</span><span class="o">.</span><span class="na">ofFloat</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span><span class="o">.</span><span class="na">addUpdateListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ValueAnimator</span><span class="o">.</span><span class="na">AnimatorUpdateListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationUpdate</span><span class="o">(</span><span class="n">ValueAnimator</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="kt">float</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">Float</span><span class="o">)</span> <span class="n">animation</span><span class="o">.</span><span class="na">getAnimatedValue</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">mMatrix</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
</span><span class='line'>          <span class="n">mMatrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="n">mScaleFactor</span><span class="o">,</span> <span class="n">mScaleFactor</span><span class="o">);</span>
</span><span class='line'>          <span class="n">mMatrix</span><span class="o">.</span><span class="na">postTranslate</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">mImageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">mMatrix</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">});</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span><span class="o">.</span><span class="na">setDuration</span><span class="o">(</span><span class="n">DURATION</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nf">AnimatorListenerAdapter</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationEnd</span><span class="o">(</span><span class="n">Animator</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span><span class="o">(</span><span class="n">mDirection</span> <span class="o">==</span> <span class="n">RightToLeft</span><span class="o">)</span>
</span><span class='line'>              <span class="n">mDirection</span> <span class="o">=</span> <span class="n">LeftToRight</span><span class="o">;</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="n">mDirection</span> <span class="o">=</span> <span class="n">RightToLeft</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">animate</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">});</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateDisplayRect</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">mDisplayRect</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">mImageView</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">().</span><span class="na">getIntrinsicWidth</span><span class="o">(),</span> <span class="n">mImageView</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">().</span><span class="na">getIntrinsicHeight</span><span class="o">());</span>
</span><span class='line'>  <span class="n">mMatrix</span><span class="o">.</span><span class="na">mapRect</span><span class="o">(</span><span class="n">mDisplayRect</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Optimizations</h1>

<p>Thanks to <a href="http://www.curious-creature.org/">Romain Guy</a> for his remarks.</p>

<p>As he said to me, we have to avoid boxing in the ValueAnimator described in the step2 (animate your background). If you don&rsquo;t know why we have to avoid boxing, you should look at those <a href="https://speakerdeck.com/cyrilmottier/optimizing-android-ui-pro-tips-for-creating-smooth-and-responsive-apps">slides</a> by <a href="http://www.cyrilmottier.com/">Cyril Mottier</a>.</p>

<p>One solution is to use an <a href="http://developer.android.com/reference/android/animation/ObjectAnimator.html"><code>ObjectAnimator</code></a> on a wrapped ImageView in order to forward changes on the real ImageView.</p>

<p>Here is a draft for this optimization</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">animate</span><span class="o">(</span><span class="kt">float</span> <span class="n">from</span><span class="o">,</span> <span class="kt">float</span> <span class="n">to</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">MatrixImageView</span> <span class="n">matrixImageView</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MatrixImageView</span><span class="o">(</span><span class="n">mImageView</span><span class="o">,</span> <span class="n">mScaleFactor</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span> <span class="o">=</span> <span class="n">ObjectAnimator</span><span class="o">.</span><span class="na">ofFloat</span><span class="o">(</span><span class="n">matrixImageView</span><span class="o">,</span> <span class="s">&quot;matrixTranslateX&quot;</span><span class="o">,</span> <span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span><span class="o">.</span><span class="na">setDuration</span><span class="o">(</span><span class="n">DURATION</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nf">AnimatorListenerAdapter</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationEnd</span><span class="o">(</span><span class="n">Animator</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span><span class="o">(</span><span class="n">mDirection</span> <span class="o">==</span> <span class="n">RightToLeft</span><span class="o">)</span>
</span><span class='line'>              <span class="n">mDirection</span> <span class="o">=</span> <span class="n">LeftToRight</span><span class="o">;</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="n">mDirection</span> <span class="o">=</span> <span class="n">RightToLeft</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">animate</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">});</span>
</span><span class='line'>  <span class="n">mCurrentAnimator</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">MatrixImageView</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ImageView</span> <span class="n">mImageView</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">float</span> <span class="n">mScaleFactor</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Matrix</span> <span class="n">mMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Matrix</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="nf">MatrixImageView</span><span class="o">(</span><span class="n">ImageView</span> <span class="n">imageView</span><span class="o">,</span> <span class="kt">float</span> <span class="n">scaleFactor</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">mImageView</span> <span class="o">=</span> <span class="n">imageView</span><span class="o">;</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">mScaleFactor</span> <span class="o">=</span> <span class="n">scaleFactor</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMatrixTranslateX</span><span class="o">(</span><span class="kt">float</span> <span class="n">dx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mMatrix</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
</span><span class='line'>      <span class="n">mMatrix</span><span class="o">.</span><span class="na">postScale</span><span class="o">(</span><span class="n">mScaleFactor</span><span class="o">,</span> <span class="n">mScaleFactor</span><span class="o">);</span>
</span><span class='line'>      <span class="n">mMatrix</span><span class="o">.</span><span class="na">postTranslate</span><span class="o">(</span><span class="n">dx</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>      <span class="n">mImageView</span><span class="o">.</span><span class="na">setImageMatrix</span><span class="o">(</span><span class="n">mMatrix</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Secondly, another way to deal with matrix when drawing a bitmap is to create a simple View (extending View) and to implement <code>onDraw(Canvas)</code> calling <code>drawBitmap (Bitmap bitmap, Matrix matrix, Paint paint)</code> method.</p>

<h1>Conclusion</h1>

<p>This article reflects in part the implementation of <a href="https://github.com/flavienlaurent/PanningView">PanningView</a> library available on Github. Anyway feel free to correct me if my approach sounds kind of wrong or if you see a problem somewhere.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Flavien Laurent</span></span>

      




<time class='entry-date' datetime='2013-08-05T18:56:00+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>6:56 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/animation/'>animation</a>, <a class='category' href='/blog/categories/imageview/'>imageview</a>, <a class='category' href='/blog/categories/matrix/'>matrix</a>, <a class='category' href='/blog/categories/playmusic/'>playmusic</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://flavienlaurent.com/blog/2013/08/05/make-your-background-moving-like-on-play-music-app/" data-via="flavienlaurent" data-counturl="http://flavienlaurent.com/blog/2013/08/05/make-your-background-moving-like-on-play-music-app/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2013/08/14/viewoverlay-when-how-and-for-what-purpose/" title="Next Post: ViewOverlay: when, how and for what purpose?">ViewOverlay: when, how and for what purpose? &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/05/screenshot_automation/">Screenshots Through Automation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/spans/">Spans, a Powerful Concept.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/20/making-your-action-bar-not-boring/">Making Your ActionBar Not Boring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/28/each-navigation-drawer-hides-a-viewdraghelper/">Each Navigation Drawer Hides a ViewDragHelper</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/14/viewoverlay-when-how-and-for-what-purpose/">ViewOverlay: When, How and for What Purpose?</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/flavienlaurent">@flavienlaurent</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'flavienlaurent',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/103561222519914490723?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Flavien Laurent -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'flavienlaurent';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://flavienlaurent.com/blog/2013/08/05/make-your-background-moving-like-on-play-music-app/';
        var disqus_url = 'http://flavienlaurent.com/blog/2013/08/05/make-your-background-moving-like-on-play-music-app/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
